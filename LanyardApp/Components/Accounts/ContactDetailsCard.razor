@using Lanyard.Application.Services.Authentication
@inject IToastService ToastService

<FluentCard>
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
        <FluentLabel Typo="Typography.H5">Other Details</FluentLabel>
        
        <EditForm class="w-50" Model="@model">
            <DataAnnotationsValidator />
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                <FluentTextField @bind-Value="model.Email"
                                 Label="Email Address"
                                 TextFieldType="TextFieldType.Email"
                                 Style="width: 100%;">
                    <FluentIcon Value="@(new Icons.Regular.Size16.Mail())" Slot="start" />
                </FluentTextField>
                <FluentValidationMessage For="@(() => model.Email)" />
                <FluentTextField @bind-Value="model.PhoneNumber"
                                 Label="Phone Number"
                                 TextFieldType="TextFieldType.Tel"
                                 Style="width: 100%;">
                    <FluentIcon Value="@(new Icons.Regular.Size16.Phone())" Slot="start" />
                </FluentTextField>
                <FluentValidationMessage For="@(() => model.PhoneNumber)" />
                <FluentDatePicker @bind-Value="model.DateOfBirth"
                                  Label="Date of Birth"
                                  Style="width: 100%;">
                    <FluentIcon Value="@(new Icons.Regular.Size16.CalendarLtr())" Slot="start" />
                </FluentDatePicker>
                <FluentValidationMessage For="@(() => model.DateOfBirth)" />
            </FluentStack>
        </EditForm>
    </FluentStack>
</FluentCard>

@code {
    private ContactDetailsModel model = new();

    protected override async Task OnInitializedAsync()
    {
        UserProfile? user = await _sApi.GetCurrentUserProfileAsync();

        if (user is not null)
        {
            model.Email = user.Email;
            model.PhoneNumber = user.PhoneNumber;
            model.DateOfBirth = user.DateOfBirth;
        }
    }

    public async Task HandleSave()
    {
        UserProfile? user = await _sApi.GetCurrentUserProfileAsync();

        if (user is not null)
        {
            user.Email = model.Email;
            user.PhoneNumber = model.PhoneNumber;
            user.DateOfBirth = model.DateOfBirth;

            await _sApi.UpdateUserProfileAsync(user);

            ToastService.ShowSuccess("Details Saved!");
        }
    }

    private class ContactDetailsModel
    {
        [EmailAddress(ErrorMessage = "Invalid email address.")]
        public string? Email { get; set; }

        [Phone(ErrorMessage = "Invalid phone number.")]
        public string? PhoneNumber { get; set; }

        public DateTime? DateOfBirth { get; set; }
    }
}
