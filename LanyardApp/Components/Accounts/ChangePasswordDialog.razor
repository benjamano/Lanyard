@using LanyardData.Models
@using System.ComponentModel.DataAnnotations
@implements IDialogContentComponent<UserProfile>

@inject IToastService ToastService

<FluentDialogHeader ShowDismiss="true">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.Key())" />
        <FluentLabel Typo="Typography.PaneHeader">
            Change Password
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>

<FluentDialogBody>
    <p>Set a new password for @Content.GetName()'s account</p>

    <EditForm Model="@model" OnValidSubmit="HandleChangePassword">
        <DataAnnotationsValidator />
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <FluentTextField @bind-Value="model.NewPassword"
                             Label="New Password"
                             Required
                             TextFieldType="TextFieldType.Password"
                             Placeholder="Enter new password"
                             Style="width: 100%;">
                <FluentIcon Value="@(new Icons.Regular.Size16.Key())" Slot="start" />
            </FluentTextField>
            <FluentValidationMessage For="@(() => model.NewPassword)" />

            <FluentTextField @bind-Value="model.ConfirmPassword"
                             Label="Confirm Password"
                             Required
                             TextFieldType="TextFieldType.Password"
                             Placeholder="Confirm new password"
                             Style="width: 100%;">
                <FluentIcon Value="@(new Icons.Regular.Size16.Key())" Slot="start" />
            </FluentTextField>
            <FluentValidationMessage For="@(() => model.ConfirmPassword)" />

            <FluentDialogFooter>
                <FluentButton Appearance="Appearance.Accent"
                              Type="ButtonType.Submit"
                              Disabled="@isSubmitting"
                              IconStart="@(new Icons.Regular.Size20.Key())">
                    @if (isSubmitting)
                    {
                        <FluentProgressRing Style="width: 16px; height: 16px;" />
                        <span class="ms-2">Changing...</span>
                    }
                    else
                    {
                        <span>Change Password</span>
                    }
                </FluentButton>
                <FluentButton Appearance="Appearance.Neutral"
                              OnClick="@CancelDialog"
                              Disabled="@isSubmitting">
                    Cancel
                </FluentButton>
            </FluentDialogFooter>
        </FluentStack>
    </EditForm>
</FluentDialogBody>

@code {
    [Parameter]
    public UserProfile Content { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog? Dialog { get; set; }

    [Parameter]
    public DialogParameters Parameters { get; set; } = default!;

    private bool isSubmitting;
    private ChangePasswordModel model = new();

    private async Task HandleChangePassword()
    {
        isSubmitting = true;
        StateHasChanged();

        try
        {
            Result<bool> result = await _sApi.ChangePasswordAsync(Content.Id, model.NewPassword);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess($"Password changed successfully for '{Content.GetName()}'!");
                await Dialog!.CloseAsync(true);
            }
            else
            {
                ToastService.ShowError($"Failed to change password: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error changing password: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task CancelDialog()
    {
        await Dialog!.CancelAsync();
    }

    private class ChangePasswordModel
    {
        [Required(ErrorMessage = "New password is required.")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "Password must be at least 6 characters long.")]
        [DataType(DataType.Password)]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Confirm password is required.")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match.")]
        [DataType(DataType.Password)]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
