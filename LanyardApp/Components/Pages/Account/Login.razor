@page "/login"

@using LanyardData.DataAccess;
@using LanyardData.Models;
@using LanyardData.DTO;
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using LanyardApp.Services

@inject HttpClient Http
@inject IToastService ToastService
@inject ApplicationDbContext _context
@inject NavigationManager Navigation
@inject TokenStorageService TokenStorage
@inject JwtAuthenticationStateProvider AuthStateProvider

<FluentStack Orientation="Orientation.Vertical" 
              VerticalAlignment="VerticalAlignment.Center"
              HorizontalAlignment="HorizontalAlignment.Center"
              Style="min-height: 70vh; padding: 16px;">
    
    <FluentCard Style="width: 400px; max-width: 90vw; padding: 32px;">
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="24">
            <FluentLabel Typo="Typography.H4" Style="text-align: center; margin-bottom: 8px;">
                Please Login
            </FluentLabel>

            <EditForm Model="LoginModel" OnValidSubmit="HandleValidSubmit" FormName="LoginModel" class="w-100">
                <DataAnnotationsValidator />
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                    <FluentTextField @bind-Value="LoginModel.Username"
                                     Label="Username"
                                     Required
                                     Disabled="@IsLoggingIn"
                                     Placeholder="Enter your username"
                                     Style="width: 100%;">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Person())" Slot="start" />
                    </FluentTextField>
                    <FluentValidationMessage For="@(() => LoginModel.Username)" />

                    <FluentTextField @bind-Value="LoginModel.Password"
                                     Label="Password"
                                     TextFieldType="TextFieldType.Password"
                                     Required
                                     Disabled="@IsLoggingIn"
                                     Placeholder="Enter your password"
                                     Style="width: 100%;">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Key())" Slot="start" />
                    </FluentTextField>
                    <FluentValidationMessage For="@(() => LoginModel.Password)" />

                    <FluentCheckbox @bind-Value="LoginModel.RememberMe"
                                    Disabled="@IsLoggingIn"
                                    Label="Remember Me" />

                    <FluentStack Orientation="Orientation.Horizontal"
                                 HorizontalAlignment="HorizontalAlignment.End"
                                 Style="margin-top: 8px;">
                        @if (IsLoggingIn)
                        {
                            <FluentButton Appearance="Appearance.Accent"
                                          Type="ButtonType.Submit"
                                          Disabled="@IsLoggingIn">
                                <FluentProgressRing Color="white" Style="width: 16px; height: 16px;" slot="start" />
                                <span>Logging you in...</span>
                            </FluentButton>
                        }
                        else
                        {
                            <FluentButton Appearance="Appearance.Accent"
                                          Type="ButtonType.Submit"
                                          Disabled="@IsLoggingIn">
                                <FluentIcon Color="Color.Fill" Icon="Icons.Regular.Size20.ArrowEnter" Slot="start" />
                                <span>Login</span>
                            </FluentButton>
                            
                        }
                    </FluentStack>
                </FluentStack>
            </EditForm>
        </FluentStack>
    </FluentCard>
</FluentStack>

@code {
    [SupplyParameterFromForm]
    public LoginDto LoginModel { get; set; } = new();

    public bool IsLoggingIn = false;

    protected override async Task OnInitializedAsync()
    {
        LoginModel ??= new();
    }

    private void HandleValidSubmit()
    {
        _ = CheckUserCredential();
    }

    private async Task CheckUserCredential()
    {
        IsLoggingIn = true;
        StateHasChanged();

        try
        {
            await Task.Delay(5000);

            HttpResponseMessage response = await Http.PostAsJsonAsync("api/auth/login", LoginModel);

            if (response.IsSuccessStatusCode)
            {
                LoginResponseDto? result = await response.Content.ReadFromJsonAsync<LoginResponseDto>();
                
                if (result != null)
                {
                    await TokenStorage.SetTokenAsync(result.Token);
                    AuthStateProvider.NotifyAuthenticationStateChanged();
                    Navigation.NavigateTo("/", forceLoad: true);
                }
            }
            else
            {
                ToastService.ShowError("Login Failed! Invalid username or password.");
            }
        }
        finally
        {
            IsLoggingIn = false;
            StateHasChanged();
        }
    }
}