@using System.Threading.Tasks
@inject ApplicationRolesService _rApi;
@inject JwtTokenService _jwtTokenService;
@inject JwtAuthenticationStateProvider _authStateProvider;
@inject UserManager<UserProfile> _umApi;

<div class="card">
    <div class="card-header">User Roles Manager</div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="form-floating">
                    @if (userProfiles is not null && userProfiles.Any())
                    {
                        <select id="userSelect" class="form-select" @onchange="OnUserChanged">
                            <option value="">Select a User...</option>
                            @foreach (UserProfile user in userProfiles)
                            {
                                <option value="@user.Id">@user.GetName()</option>
                            }
                        </select>
                    }
                    else
                    {
                        <select class="form-select" disabled>
                            <option>Loading...</option>
                        </select>
                    }
                    <label for="userSelect" class="form-label">Select User</label>
                </div>
            </div>
            <div class="col-md-5">
                @if (selectedUserId != string.Empty && selectedUserId != null)
                {
                    <div class="card">
                        <div class="card-header">Assigned Roles</div>
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover w-100 h-100 small">
                                <thead>
                                    <tr>
                                        <td class="col-6">Role</td>
                                        <td class="col-3">Date Created</td>
                                        <td class="col-3">Created By</td>
                                        <td class="col-2">Actions</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (userRoles.Count() == 0)
                                    {
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No Roles Exist for this User</td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (ApplicationRole role in userRoles)
                                        {
                                            <tr>
                                                <td class="col-6">@role.Name</td>
                                                <td class="col-3">@role.CreateDate.ToString("g")</td>
                                                <td class="col-3">@role.CreatedByUser?.GetName()</td>
                                                <td>
                                                    <div class="d-flex flex-row">
                                                        <span role="button" class="fas fa-trash text-danger" @onclick="() => RemoveRoleFromUser(role.Id)"></span>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>

            <div class="col-md-3">
                @if (selectedUserId != string.Empty && selectedUserId != null)
                {
                    <div class="card">
                        <div class="card-header">Assign New Roles</div>
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover w-100 h-100 small">
                                <thead>
                                    <tr>
                                        <td class="col-3">Name</td>
                                        <td class="col-2">Actions</td>
                                    </tr>
                                </thead>
                                <tbody>
                                @if (roles is not null)
                                {
                                    if (roles.Count() == 0)
                                    {
                                        <tr>
                                            <td colspan="2" class="text-center text-muted">
                                                No Roles Exist Yet
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        IEnumerable<string> assignedRoleIds = userRoles.Select(x => x.Id);
                                        IEnumerable<ApplicationRole> availableRoles = roles
                                            .Where(x => !assignedRoleIds.Contains(x.Id))
                                            .OrderBy(x => x.Name);

                                        if (availableRoles.Any())
                                        {
                                            @foreach (ApplicationRole role in availableRoles)
                                            {
                                                <tr>
                                                    <td class="col-3">@role.Name</td>
                                                    <td class="col-2">
                                                        <div class="d-flex flex-row">
                                                            <span role="button" class="fas fa-plus-circle text-success" @onclick="() => AddRoleToUser(role.Id)"></span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="2" class="text-center text-muted">
                                                    No Roles left to Assign!
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="2" class="text-center text-muted">
                                            <span class="fas fa-spinner fa-spin me-0 bg-transparent"></span>
                                            Loading...
                                        </td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private IEnumerable<UserProfile> userProfiles = Array.Empty<UserProfile>();
    private string? selectedUserId = null;

    private IEnumerable<ApplicationRole> roles = Array.Empty<ApplicationRole>();
    private IEnumerable<ApplicationRole> userRoles = Array.Empty<ApplicationRole>();

    protected override async Task OnInitializedAsync()
    {
        userProfiles = await _sec.GetAllUsersAsync();
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        Result<List<ApplicationRole>> result = await _rApi.GetAllApplicationRolesAsync();

        if (result.IsSuccess)
        {
            roles = result.Data!;
        }
        else
        {
            _tApi.ShowError("Failed to load roles", result.Error!);
        }

        StateHasChanged();
    }

    public async Task SetRoles(IEnumerable<ApplicationRole> _roles)
    {
        roles = _roles;
        StateHasChanged();
    }

    private string GetSelectedUserName()
    {
        UserProfile? user = userProfiles.FirstOrDefault(u => u.Id == selectedUserId);
        return user?.GetName() ?? string.Empty;
    }

    private async Task LoadUsersRoles()
    {
        Result<List<ApplicationRole>> result = await _rApi.GetUserRolesAsync(selectedUserId!);

        if (result.IsSuccess)
        {
            userRoles = result.Data!;
        }
        else
        {
            _tApi.ShowError("Failed to load user roles", result.Error!);
        }

        StateHasChanged();
    }

    private async Task OnUserChanged(ChangeEventArgs e)
    {
        selectedUserId = e.Value?.ToString();
        await LoadUsersRoles();
    }

    private async Task AddRoleToUser(string roleId)
    {
        Result<string> result = await _rApi.AssignRoleToUserAsync(selectedUserId!, roleId);

        if (!result.IsSuccess)
        {
            _tApi.ShowError("Assign Role Failed", result.Error!);
            return;
        }

        string? currentUserId = await _sec.GetCurrentUserIdAsync();
        if (result.Data == currentUserId)
        {
            UserProfile? currentUser = await _umApi.FindByIdAsync(currentUserId!);
            if (currentUser is not null)
            {
                await _jwtTokenService.RegenerateTokenAsync(currentUser);
                _authStateProvider.NotifyAuthenticationStateChanged();
            }
        }

        _tApi.ShowSuccess("Role Assigned", "The role has been successfully assigned to the user.");
        await LoadUsersRoles();
    }

    private async Task RemoveRoleFromUser(string roleId)
    {
        Result<string> result = await _rApi.RemoveRoleFromUserAsync(selectedUserId!, roleId);

        if (!result.IsSuccess)
        {
            _tApi.ShowError("Remove Role Failed", result.Error!);
            return;
        }

        string? currentUserId = await _sec.GetCurrentUserIdAsync();
        if (result.Data == currentUserId)
        {
            UserProfile? currentUser = await _umApi.FindByIdAsync(currentUserId!);
            if (currentUser is not null)
            {
                await _jwtTokenService.RegenerateTokenAsync(currentUser);
                _authStateProvider.NotifyAuthenticationStateChanged();
            }
        }

        _tApi.ShowSuccess("Role Removed", "The role has been successfully removed from the user.");
        await LoadUsersRoles();
    }
}