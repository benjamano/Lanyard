@using LanyardData.Models

@inject ApplicationRolesService _rApi;
@inject JwtTokenService _jwtTokenService;
@inject JwtAuthenticationStateProvider _authStateProvider;
@inject UserManager<UserProfile> _umApi;

<div class="card mt-2">
    <div class="card-header">
        Role Manager

        <button class="btn btn-primary" @onclick="HandleCreateNewRoleButtonClicked">
            Create a new Role
        </button>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-@(isCreatingARole ? "8" : "12")">
                <div class="card">
                    <div class="card-header">Existing Roles</div>
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover w-100 h-100">
                            <thead>
                                <tr>
                                    <td class="col-3">Name</td>
                                    <td class="col-2">Created By</td>
                                    <td class="col-2">Created Date</td>
                                    <td class="col-2">Actions</td>
                                </tr>
                            </thead>
                            <tbody>
                                @if (roles is not null)
                                {
                                    if (roles.Count() == 0)
                                    {
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                No Roles Exist Yet
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (ApplicationRole role in roles.OrderBy(x => x.Name))
                                        {
                                            <tr>
                                                <td class="col-3">@role.Name</td>
                                                <td class="col-2">@role.CreatedByUser?.GetName()</td>
                                                <td class="col-2">@role.CreateDate.ToString("g")</td>
                                                <td class="col-2">
                                                    <div class="d-flex flex-row">
                                                        <span role="button" @onclick="() => DeleteRole(role.Id)" class="fas fa-trash text-danger"></span>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            <span class="fas fa-spinner fa-spin me-0 bg-transparent"></span>
                                            Loading...
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="@(isCreatingARole ? "col-4" : "d-none")">
                <div class="card">
                    <div class="card-header">Create a New Role</div>
                    <div class="card-body">
                        <EditForm Model="@model" OnValidSubmit="HandleCreateNewRole">
                            <DataAnnotationsValidator />

                            <div class="form-floating">
                                <InputText id="roleName" class="form-control" @bind-Value="model.RoleName" />
                                <label for="roleName">Role Name</label>
                                <ValidationMessage For="@(() => model.RoleName)" />
                            </div>

                            <button type="submit" class="btn btn-outline-primary float-end mt-2">Create</button>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<IEnumerable<ApplicationRole>> OnRolesChanged { get; set; }

    private IEnumerable<ApplicationRole>? roles = null;
    private string selectedRoleId = string.Empty;
    private bool isCreatingARole = false;

    private CreateNewRolesModel model = new CreateNewRolesModel();

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
        model.RoleName = "";
    }

    private async Task LoadRoles()
    {
        Result<List<ApplicationRole>> result = await _rApi.GetAllApplicationRolesAsync();

        if (result.IsSuccess)
        {
            roles = result.Data!;
        }
        else
        {
            _tApi.ShowError("Failed to load roles", result.Error!);
        }

        StateHasChanged();
    }

    public async Task SetRoles(IEnumerable<ApplicationRole> _roles)
    {
        roles = _roles;
        StateHasChanged();
    }

    private string GetSelectedRoleName()
    {
        ApplicationRole? selectedRole = roles?
            .Where(r => r.Id == selectedRoleId)
            .FirstOrDefault();

        return selectedRole?.Name ?? string.Empty;
    }

    private void HandleCreateNewRoleButtonClicked()
    {
        isCreatingARole = !isCreatingARole;
    }

    private async Task HandleCreateNewRole()
    {
        Result<bool> result = await _rApi.CreateNewRoleAsync(model.RoleName);

        if (!result.IsSuccess)
        {
            _tApi.ShowError("Error while Creating Role", result.Error!);
            return;
        }

        await LoadRoles();

        _tApi.ShowSuccess("Role Created", "Role Created Successfully!");

        model.RoleName = "";

        if (roles is not null)
        {
            await OnRolesChanged.InvokeAsync(roles);
        }
    }

    private async Task DeleteRole(string roleId)
    {
        Result<List<string>> result = await _rApi.DeleteRoleAsync(roleId);

        if (!result.IsSuccess)
        {
            _tApi.ShowError("Error deleting Role", result.Error!);
            return;
        }

        string? currentUserId = await _sec.GetCurrentUserIdAsync();
        if (result.Data is not null && result.Data.Contains(currentUserId!))
        {
            UserProfile? currentUser = await _umApi.FindByIdAsync(currentUserId!);
            if (currentUser is not null)
            {
                await _jwtTokenService.RegenerateTokenAsync(currentUser);
                _authStateProvider.NotifyAuthenticationStateChanged();
            }
        }

        await LoadRoles();

        _tApi.ShowSuccess("Role Deleted", "Role Deleted Successfully!");

        if (roles is not null)
        {
            await OnRolesChanged.InvokeAsync(roles);
        }
    }

    private class CreateNewRolesModel
    {
        [Required(ErrorMessage = "The Role Name field is required.")]
        public string RoleName { get; set; } = string.Empty;
    }
}