@using LanyardData.Models

@inject ApplicationRolesService _rApi;

<PageTitle>User Roles</PageTitle>

<div class="card mt-2">
    <div class="card-header">
        User Roles Manager

        <button class="btn btn-primary" @onclick="HandleCreateNewRoleButtonClicked">
            Create a new Role
        </button>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-@(isCreatingARole ? "8" : "12")">
                <div class="card">
                    <div class="card-header">Existing Roles</div>
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover w-100 h-100">
                            <thead>
                                <tr>
                                    @* <td class="col-1">Id</td> *@
                                    <td class="col-3">Name</td>
                                    <td class="col-2">Created By</td>
                                    <td class="col-2">Created Date</td>
                                    <td class="col-2">Actions</td>
                                </tr>
                            </thead>
                            <tbody>
                                @if (roles is not null)
                                {
                                    if (roles.Count() == 0)
                                    {
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                No Roles Exist Yet
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (ApplicationRole role in roles)
                                        {
                                            <tr>
                                                @* <td class="col-1">@role.Id</td> *@
                                                <td class="col-3">@role.Name</td>
                                                <td class="col-2">@role.CreatedByUser!.GetName()</td>
                                                <td class="col-2">@role.CreateDate.ToString("g")</td>
                                                <td class="col-2">
                                                    <div class="d-flex flex-row">
                                                        <span role="button" @onclick="() => DeleteRole(role.Id)" class="fas fa-trash text-danger"></span>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <span class="fas fa-spinner fa-spin me-0 bg-transparent"></span>
                                            Loading...
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="@(isCreatingARole ? "col-4" : "d-none")">
                <div class="card">
                    <div class="card-header">Create a New Role</div>
                    <div class="card-body">
                        <EditForm Model="@model" OnValidSubmit="HandleCreateNewRole">
                            <DataAnnotationsValidator />

                            <div class="form-floating">
                                <InputText id="roleName" class="form-control" @bind-Value="model.RoleName" />
                                <label for="roleName">Role Name</label>
                                <ValidationMessage For="@(() => model.RoleName)" />
                            </div>

                            <button type="submit" class="btn btn-outline-primary float-end mt-2">Create</button>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IEnumerable<ApplicationRole>? roles = null;
    private string selectedRoleId = string.Empty;
    private bool isCreatingARole = false;
    private bool isSavingNewRole = false;

    private CreateNewRolesModel model = new();

    protected override async Task OnInitializedAsync()
    {
        SetRoles(await _rApi.GetAllApplicationRolesAsync());

        model.RoleName = "";
    }

    private void SetRoles(IEnumerable<ApplicationRole> _roles)
    {
        roles = _roles;

        StateHasChanged();
    }

    private string GetSelectedRoleName()
    {
        return roles!
            .Where(r => r.Id == selectedRoleId)
            .FirstOrDefault()?
            .Name ?? string.Empty;
    }

    private void HandleCreateNewRoleButtonClicked()
    {
        isCreatingARole = !isCreatingARole;
    }

    private async Task HandleCreateNewRole()
    {
        await _rApi.CreateNewRoleAsync(model.RoleName);
        SetRoles(await _rApi.GetAllApplicationRolesAsync());

        _tApi.SetLevel(ToastErrorLevels.Success);
        _tApi.SetTitle("Succesfully Added Role!");
        _tApi.Show();

        model.RoleName = "";
    }

    private async Task DeleteRole(string RoleId)
    {
        await _rApi.DeleteRole(RoleId);

        SetRoles(await _rApi.GetAllApplicationRolesAsync());

        _tApi.SetLevel(ToastErrorLevels.Success);
        _tApi.SetTitle("Role Deleted");
        _tApi.Show();
    }

    private class CreateNewRolesModel
    {
        [Required(ErrorMessage = "The Role Name field is required.")]
        public string RoleName { get; set; } = string.Empty;
    }
}