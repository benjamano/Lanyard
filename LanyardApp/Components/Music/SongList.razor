@using System.Threading.Tasks
@using Lanyard.App.Components.Music;
@using Lanyard.Application.Services
@using Lanyard.Application.Services.Authentication
@using Lanyard.Infrastructure.DataAccess
@using Lanyard.Infrastructure.Models;
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext _context
@inject IDialogService DialogService
@inject IToastService ToastService
@inject MusicPlayerService _player

@implements IDisposable

<FluentCard Height="auto" Style="width: 100%;">
    <FluentStack Orientation="Orientation.Vertical" Style="width: 100%;">
        @if (Songs is not null && Songs.Any())
        {
            <FluentDataGrid Items="@Songs.AsQueryable()" 
                            GridTemplateColumns="100px 2fr 1.5fr 1fr 100px"
                            Style="width: 100%;">
                <ChildContent>
                    <TemplateColumn Title="#" Align="Align.End">
                        <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                            @if (IsCurrentlyPlaying(context.Song!))
                            {
                                <FluentIcon Value="@(new Icons.Regular.Size16.Speaker2())" 
                                           Color="Color.Accent" 
                                           Style="cursor: pointer;"
                                            @onclick="() => _player.Play(context.Song!, context.Playlist!)" />
                            }

                            <FluentIcon Value="@(new Icons.Regular.Size16.Add())" 
                                       Color="Color.Accent" 
                                       Style="cursor: pointer;"
                                       @onclick="@((MouseEventArgs e) => HandleAddSongClick(e, context.Song!))" />

                            <span style="text-align: right;">@(Songs.ToList().IndexOf(context) + 1 != 0 ? Songs.ToList().IndexOf(context) + 1 : "")</span>
                        </div>
                    </TemplateColumn>

                    <TemplateColumn Title="Title">
                        <div style="cursor: pointer; display: flex; align-items: center;"
                             @onclick="() => _player.Play(context.Song!, context.Playlist!)">
                            <FluentLabel Weight="@(IsCurrentlyPlaying(context.Song!) ? FontWeight.Bold : FontWeight.Normal)"
                                         Style="@(IsCurrentlyPlaying(context.Song!) ? "color: var(--accent-fill-rest);" : "")">
                                @context.Song!.Name
                            </FluentLabel>
                        </div>
                    </TemplateColumn>

                    <TemplateColumn Title="Album">
                        <div style="cursor: pointer;"
                             @onclick="() => _player.Play(context.Song!, context.Playlist!)">
                            <FluentLabel>@context.Song!.AlbumName</FluentLabel>
                        </div>
                    </TemplateColumn>

                    <TemplateColumn Title="Date Added">
                        <div style="cursor: pointer;"
                             @onclick="() => _player.Play(context.Song!, context.Playlist!)">
                            <FluentLabel>@context.Song!.CreateDate.ToString("d")</FluentLabel>
                        </div>
                    </TemplateColumn>

                    <TemplateColumn Title="Length" Align="Align.Start">
                        <div style="cursor: pointer;"
                             @onclick="() => _player.Play(context.Song!, context.Playlist!)">
                            <FluentLabel>@TimeSpan.FromSeconds(context.Song!.DurationSeconds).ToString(@"mm\:ss")</FluentLabel>
                        </div>
                    </TemplateColumn>
                </ChildContent>
            </FluentDataGrid>
        }
        else
        {
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" 
                         VerticalAlignment="VerticalAlignment.Center" 
                         Style="height: 200px;">
                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                    No songs available
                </FluentLabel>
            </FluentStack>
        }
    </FluentStack>
</FluentCard>

<style>
    fluent-data-grid-row {
        cursor: pointer;
    }

    fluent-data-grid-row:hover {
        background-color: var(--neutral-fill-stealth-hover);
    }
</style>

@code {
    [Parameter] public IEnumerable<PlaylistSongMember>? Songs { get; set; }

    private Guid? CurrentlyPlayingSongId;

    protected override void OnInitialized()
    {
        _player.OnSongChanged += UpdateCurrentSong;
    }

    private void UpdateCurrentSong(Guid? songid)
    {
        CurrentlyPlayingSongId = songid;
        InvokeAsync(StateHasChanged);
    }

    private bool IsCurrentlyPlaying(Song song)
    {
        return CurrentlyPlayingSongId.HasValue && CurrentlyPlayingSongId.Value == song.Id;
    }

    private async Task OpenAddSongToPlaylistDialog(Song song)
    {
        SongPlaylistSelection selection = new SongPlaylistSelection 
        { 
            Song = song,
            Playlist = null! // Will be set by the dialog
        };

        DialogParameters parameters = new DialogParameters()
        {
            Title = $"Add {song.Name} To Playlist",
            OnDialogResult = DialogService.CreateDialogCallback(this, HandleAddSongToPlaylist),
            PrimaryAction = "Add",
            PrimaryActionEnabled = false,
            SecondaryAction = "Cancel",
            Width = "500px",
            Height = "auto",
            TrapFocus = true,
            Modal = true,
        };

        await DialogService.ShowDialogAsync<AddSongToPlaylistModal>(selection, parameters);
    }

    private async Task HandleAddSongToPlaylist(DialogResult result)
    {
        if (result.Cancelled || result.Data is not SongPlaylistSelection selection)
        {
            return;
        }

        Song song = selection.Song;
        Playlist selectedPlaylist = selection.Playlist;
        
        if (selectedPlaylist is null)
        {
            ToastService.ShowWarning("Please select a playlist");
            return;
        }

        try
        {
            Song? existingSong = await _context.Songs
                .Where(x => x.Id == song.Id)
                .FirstOrDefaultAsync();

            if (existingSong is null)
            {
                existingSong = new Song
                {
                    Id = Guid.NewGuid(),
                    Name = song.Name,
                    AlbumName = song.AlbumName,
                    FilePath = song.FilePath,
                    DurationSeconds = song.DurationSeconds,
                    CreateDate = DateTime.UtcNow,
                    IsDownloaded = true,
                    IsActive = true
                };

                _context.Add(existingSong);
                await _context.SaveChangesAsync();
            }

            bool alreadyInPlaylist = await _context.PlaylistSongMembers
                .AnyAsync(psm => psm.SongId == existingSong.Id 
                              && psm.PlaylistId == selectedPlaylist.Id 
                              && psm.DeleteDate == null);

            if (alreadyInPlaylist)
            {
                ToastService.ShowWarning($"'{song.Name}' is already in '{selectedPlaylist.Name}'");
                return;
            }

            PlaylistSongMember playlistSongMember = new PlaylistSongMember
            {
                SongId = existingSong.Id,
                PlaylistId = selectedPlaylist.Id,
                CreateDate = DateTime.UtcNow
            };

            _context.Add(playlistSongMember);
            await _context.SaveChangesAsync();

            ToastService.ShowSuccess($"Added '{song.Name}' to '{selectedPlaylist.Name}'");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to add song: {ex.Message}");
        }
    }

    private async Task HandleAddSongClick(MouseEventArgs e, Song song)
    {
        await OpenAddSongToPlaylistDialog(song);
    }

    public void Dispose()
    {
        _player.OnSongChanged -= UpdateCurrentSong;
    }
}}