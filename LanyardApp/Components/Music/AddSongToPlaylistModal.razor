@using Lanyard.Application.Services.Authentication
@using Lanyard.Infrastructure.DataAccess
@using Lanyard.Infrastructure.Models
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext _context
@inject IToastService ToastService
@implements IDialogContentComponent<SongPlaylistSelection>

<FluentDialogBody>
    @if (isLoading)
    {
        <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="8">
            <FluentProgressRing />
            <FluentLabel>Loading playlists...</FluentLabel>
        </FluentStack>
    }
    else if (!Playlists.Any())
    {
        <FluentStack VerticalGap="16">
            <FluentLabel Style="text-align: center; color: var(--neutral-foreground-hint);">
                No playlists available. Create a playlist first.
            </FluentLabel>
        </FluentStack>
    }
    else
    {
        <FluentSelect TOption="Playlist"
                      Items="@Playlists"
                      OptionText="@(p => p.Name)"
                      OptionValue="@(p => p.Id.ToString())"
                      SelectedOptionChanged="@OnPlaylistSelected"
                      Placeholder="Select Playlist"
                      Label="Playlist"
                      Style="width: 100%;" />
    }
</FluentDialogBody>

@code {
    [Parameter]
    public SongPlaylistSelection Content { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog? Dialog { get; set; }

    [Parameter]
    public DialogParameters Parameters { get; set; } = default!;

    private bool isLoading = true;
    private IEnumerable<Playlist> Playlists = Enumerable.Empty<Playlist>();

    protected override async Task OnInitializedAsync()
    {
        await LoadPlaylists();
    }

    private async Task LoadPlaylists()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            Playlists = await _context.Playlists
                .AsNoTracking()
                .Where(p => p.DeleteDate == null)
                .OrderByDescending(p => p.CreateDate)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load playlists: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            TogglePrimaryActionButton();
            StateHasChanged();
        }
    }

    private void OnPlaylistSelected(Playlist? playlist)
    {
        if (playlist is not null)
        {
            Content.Playlist = playlist;
        }
        
        TogglePrimaryActionButton();
    }

    private void TogglePrimaryActionButton()
    {
        Dialog?.TogglePrimaryActionButton(Content.Playlist is not null && Playlists.Any());
    }
}
