@using Lanyard.Application.Services
@using Lanyard.Application.Services.Authentication
@using Lanyard.Infrastructure.DataAccess
@using Lanyard.Infrastructure.Models
@using Microsoft.EntityFrameworkCore
@using NAudio.Wave

@inject IPlaylistService _playlistService;
@inject IMusicService _musicService;
@inject MusicPlayerService _player
@inject IDialogService DialogService
@inject IToastService ToastService

@using Lanyard.App.Components.Music;

<FluentStack Width="auto" class="ps-1 h-100" Orientation="Orientation.Vertical">
    @if (playlists == null)
    {
        <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Class="h-100">
            <FluentProgressRing />
            <FluentLabel>Loading playlists...</FluentLabel>
        </FluentStack>
    }
    else
    {
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 280px)); gap: 16px;">
            @foreach (Playlist playlist in playlists)
            {
                <FluentCard class="playlist-card p-2" Style="@GetPlaylistCardStyle(playlist.Id)"
                            @onclick="() => LoadPlaylist(playlist.Id)">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12">
                        <div style="width: 64px; height: 64px; border-radius: 8px; background-color: @GetPlaylistColor(playlist.Name); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <FluentLabel Style="color: white; font-size: 24px; font-weight: bold;">
                                @GetInitials(playlist.Name)
                            </FluentLabel>
                        </div>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="overflow: hidden; flex: 1;">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold" Style="@GetPlaylistNameStyle(playlist.Id)">
                                @playlist.Name
                            </FluentLabel>
                            @if (!string.IsNullOrEmpty(playlist.Description))
                            {
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    @playlist.Description
                                </FluentLabel>
                            }
                            else if (playlist.CreateByUser is not null)
                            {
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @playlist.CreateByUser.UserName
                                </FluentLabel>
                            }
                            else
                            {
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @playlist.CreateDate.ToString("g")
                                </FluentLabel>
                            }
                        </FluentStack>
                    </FluentStack>
                </FluentCard>
            }

            <FluentCard Class="playlist-card p-2" Style="@GetAllSongsCardStyle()"
                        @onclick="ShowAllSongs">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12">
                    <div style="width: 64px; height: 64px; border-radius: 8px; background-color: @GetPlaylistColor("All Songs"); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <FluentIcon Value="@(new Icons.Regular.Size24.MusicNote2())" Color="Color.Custom" CustomColor="white" />
                    </div>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="overflow: hidden; flex: 1;">
                        <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            All Songs
                        </FluentLabel>
                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            All Songs inside Lanyard
                        </FluentLabel>
                    </FluentStack>
                </FluentStack>
            </FluentCard>

            <AuthorizeView Roles="Admin,CanManagePlaylists" Context="context_">
                <Authorized>
                    <FluentCard Class="playlist-card p-2" Style="cursor: pointer;"
                                @onclick="CreateNewPlaylist">
                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12">
                            <div style="width: 64px; height: 64px; border-radius: 8px; background-color: @GetPlaylistColor("New"); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <FluentIcon Value="@(new Icons.Regular.Size24.Add())" Color="Color.Custom" CustomColor="white" />
                            </div>
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="overflow: hidden; flex: 1;">
                                <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    New Playlist
                                </FluentLabel>
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    Create a New Playlist
                                </FluentLabel>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                </Authorized>
            </AuthorizeView>
        </div>
    }
</FluentStack>

@code {
    [Parameter] public EventCallback<IEnumerable<PlaylistSongMember>> OnSongsSelected { get; set; }

    private Guid? selectedPlaylistId;
    private Guid? currentlyPlayingPlaylistId;

    private bool allSongsSelected;

    private List<Playlist>? playlists;

    private static readonly string[] colors = 
    {
        "#1DB954", "#E91E63", "#9C27B0", "#673AB7", "#3F51B5",
        "#2196F3", "#00BCD4", "#009688", "#4CAF50", "#FF9800",
        "#FF5722", "#795548", "#607D8B", "#E040FB", "#536DFE"
    };

    protected override async Task OnInitializedAsync()
    {
        Result<IEnumerable<Playlist>> result = await _playlistService.GetActivePlaylistsAsync();

        if (result.IsSuccess)
        {
            playlists = result.Data!
                .OrderByDescending(p => p.CreateDate)
                .ToList();
        }
        else
        {
            ToastService.ShowError("Failed to load playlists: " + result.Error);
            playlists = new List<Playlist>();
        }

        UpdateCurrentPlaylist();
    }

    private string GetPlaylistCardStyle(Guid playlistId)
    {
        List<string> styles = new List<string> { "cursor: pointer" };

        if (selectedPlaylistId == playlistId)
        {
            styles.Add("background-color: var(--neutral-fill-stealth-active)");
        }

        if (currentlyPlayingPlaylistId == playlistId)
        {
            styles.Add("border: 2px solid var(--accent-fill-rest)");
        }

        return string.Join("; ", styles) + ";";
    }

    private string GetPlaylistNameStyle(Guid playlistId)
    {
        List<string> styles = new List<string>
        { 
            "overflow: hidden", 
            "text-overflow: ellipsis", 
            "white-space: nowrap" 
        };

        if (currentlyPlayingPlaylistId == playlistId)
        {
            styles.Add("color: var(--accent-fill-rest)");
        }

        return string.Join("; ", styles) + ";";
    }

    private string GetAllSongsCardStyle()
    {
        List<string> styles = new List<string> { "cursor: pointer" };

        if (allSongsSelected)
        {
            styles.Add("background-color: var(--neutral-fill-stealth-active)");
        }

        if (currentlyPlayingPlaylistId == null && _player.CurrentPlaybackState == PlaybackState.Playing)
        {
            styles.Add("border: 2px solid var(--accent-fill-rest)");
        }

        return string.Join("; ", styles) + ";";
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var words = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);

        if (words.Length == 1)
            return name.Substring(0, Math.Min(2, name.Length)).ToUpper();

        return (words[0][0].ToString() + words[1][0].ToString()).ToUpper();
    }

    private string GetPlaylistColor(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return colors[0];

        int hash = Math.Abs(name.GetHashCode());
        return colors[hash % colors.Length];
    }

    private async Task LoadPlaylist(Guid playlistId)
    {
        selectedPlaylistId = playlistId;
        allSongsSelected = false;

        IEnumerable<PlaylistSongMember> songs = Array.Empty<PlaylistSongMember>();

        Result<IEnumerable<PlaylistSongMember>> playlistSongsResult = await _playlistService.GetPlaylistMembersAsync(playlistId);

        if (playlistSongsResult.IsSuccess)
        {
            songs = playlistSongsResult.Data!
                .OrderBy(s => s.Song!.Name);
        }
        else
        {
            ToastService.ShowError("Failed to load playlist songs: " + playlistSongsResult.Error);
        }

        await OnSongsSelected.InvokeAsync(songs);
    }

    private async Task ShowAllSongs()
    {
        selectedPlaylistId = null;
        allSongsSelected = true;

        List<Song> songs = new List<Song>();

        Result<IEnumerable<Song>> result = await _musicService.GetSongsAsync();

        if (result.IsSuccess)
        {
            songs = result.Data!.ToList();
        }
        else
        {
            ToastService.ShowError("Failed to load songs: " + result.Error);
            return;
        }

        await OnSongsSelected.InvokeAsync(songs.Select(x=> new PlaylistSongMember
        {
            PlaylistId = Guid.Empty,
            Playlist = null,
            Song = x,
            SongId = x.Id
        }));
    }

    private async Task CreateNewPlaylist() 
    {
        Playlist playlist = new Playlist
        {
            Name = string.Empty
        };

        DialogParameters parameters = new DialogParameters()
        {
            Title = "Create New Playlist",
            OnDialogResult = DialogService.CreateDialogCallback(this, HandleSavePlaylist),
            PrimaryAction = "Create",
            PrimaryActionEnabled = false,
            SecondaryAction = "Cancel",
            Width = "500px",
            Height = "auto",
            TrapFocus = true,
            Modal = true,
        };

        await DialogService.ShowDialogAsync<NewPlaylistModal>(playlist, parameters);
    }

    private async Task HandleSavePlaylist(DialogResult result)
    {
        if (result.Cancelled || result.Data is not Playlist playlist)
        {
            return;
        }

        Result<IEnumerable<Playlist>> playlistResult = await _playlistService.GetActivePlaylistsAsync();

        if (playlistResult.IsSuccess)
        {
            playlists = playlistResult.Data!
                .OrderByDescending(p => p.CreateDate)
                .ToList();
        }
        else
        {
            ToastService.ShowError("Failed to load playlists: " + playlistResult.Error);
            playlists = new List<Playlist>();
        }

        StateHasChanged();
    }

    private void UpdateCurrentPlaylist()
    {
        currentlyPlayingPlaylistId = _player.CurrentPlaylist?.Id;
        StateHasChanged();
    }
}
