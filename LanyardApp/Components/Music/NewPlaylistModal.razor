@using System.ComponentModel.DataAnnotations
@using Lanyard.Application.Services.Authentication
@using Lanyard.Infrastructure.DataAccess
@using Lanyard.Infrastructure.Models
@implements IDialogContentComponent<Playlist>

@inject IToastService ToastService
@inject ApplicationDbContext _context

<FluentDialogHeader ShowDismiss="true">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.MusicNote2())" />
        <FluentLabel Typo="Typography.PaneHeader">
            Create New Playlist
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>

<FluentDialogBody>
    <EditForm Model="@model" OnValidSubmit="HandleSavePlaylist">
        <DataAnnotationsValidator />
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <FluentTextField @bind-Value="model.Name"
                             Label="Playlist Name"
                             Required
                             Placeholder="My Awesome Playlist"
                             Style="width: 100%;"
                             @oninput="@OnNameChanged">
                <FluentIcon Value="@(new Icons.Regular.Size16.MusicNote2())" Slot="start" />
            </FluentTextField>
            <FluentValidationMessage For="@(() => model.Name)" />
            <FluentTextArea @bind-Value="model.Description"
                            Label="Description (Optional)"
                            Placeholder="Add a description..."
                            Rows="3"
                            Style="width: 100%;">
            </FluentTextArea>
            <FluentValidationMessage For="@(() => model.Description)" />
            <FluentDialogFooter>
                <FluentButton Appearance="Appearance.Accent"
                              Type="ButtonType.Submit"
                              Disabled="@isSubmitting"
                              IconStart="@(new Icons.Regular.Size20.Add())">
                    @if (isSubmitting)
                    {
                        <FluentProgressRing Style="width: 16px; height: 16px;" />
                        <span class="ms-2">Creating...</span>
                    }
                    else
                    {
                        <span>Create</span>
                    }
                </FluentButton>
                <FluentButton Appearance="Appearance.Neutral"
                              OnClick="@CancelDialog"
                              Disabled="@isSubmitting">
                    Cancel
                </FluentButton>
            </FluentDialogFooter>
        </FluentStack>
    </EditForm>
</FluentDialogBody>

@code {
    [Parameter]
    public Playlist Content { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog? Dialog { get; set; }

    [Parameter]
    public DialogParameters Parameters { get; set; } = default!;

    private bool isSubmitting;
    private NewPlaylistModel model = new();

    protected override void OnInitialized()
    {
        TogglePrimaryActionButton(false);
    }

    private void OnNameChanged(ChangeEventArgs e)
    {
        bool hasName = !string.IsNullOrWhiteSpace(e.Value?.ToString());
        TogglePrimaryActionButton(hasName);
    }

    private async Task HandleSavePlaylist()
    {
        isSubmitting = true;
        StateHasChanged();

        try
        {
            Playlist playlist = new Playlist
            {
                Name = model.Name,
                Description = model.Description,
                CreateDate = DateTime.UtcNow
            };

            _context.Playlists.Add(playlist);
            await _context.SaveChangesAsync();

            ToastService.ShowSuccess($"Playlist '{playlist.Name}' created successfully!");
            await Dialog!.CloseAsync(playlist);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error creating playlist: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task CancelDialog()
    {
        await Dialog!.CancelAsync();
    }

    private void TogglePrimaryActionButton(bool enable)
    {
        Dialog?.TogglePrimaryActionButton(enable);
    }

    private class NewPlaylistModel
    {
        [Required(ErrorMessage = "Playlist name is required.")]
        public string Name { get; set; } = string.Empty;

        public string? Description { get; set; }
    }
}
